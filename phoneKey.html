<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mac Face Unlock</title>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
body {
  background: #1e1e1e;
  color: #fff;
  font-family: "Segoe UI", sans-serif;
  display: flex;
  justify-content: center;
  padding: 20px;
  margin: 0;
}

.app {
  text-align: center;
  width: 100%;
  max-width: 680px;
}

.status {
  background: #333;
  padding: 10px;
  border-radius: 4px;
  margin-bottom: 15px;
  color: #ffcc00;
  font-weight: bold;
}

.controls {
  margin-bottom: 15px;
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

input {
  padding: 8px;
  border-radius: 4px;
  border: none;
}

button {
  padding: 8px 15px;
  cursor: pointer;
  background: #4caf50;
  color: white;
  border: none;
  border-radius: 4px;
  font-weight: bold;
  font-size: 1rem;
}

button:disabled {
  background: #555;
  cursor: not-allowed;
}

.btn-danger {
  background: #f44336;
}

.video-container {
  position: relative;
  width: 100%;
  max-width: 640px; 
  height: auto; 
  margin: 0 auto;
  overflow: hidden;
  border-radius: 10px;
  background: #000;
}

video {
  width: 100%;
  height: auto;
  display: block;
  transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
}

canvas {
  position: absolute;
  top: 0;
  left: 0;
  transform: scaleX(-1); /* Canvas ä¹Ÿè¦ä¸€èµ·é¡åƒç¿»è½‰ */
}

.overlay-layer {
  position: absolute;
  top: 0; 
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
  transform: scaleX(-1); /* ç¿»è½‰å›ä¾†ä»¥é¡¯ç¤ºæ–‡å­— */
}

.overlay-content {
  text-align: center;
  color: white;
  transform: scaleX(-1); /* æ–‡å­—å…§å®¹å†ç¿»è½‰ä¸€æ¬¡ç¢ºä¿æ­£å‘ */
}

#btnNext {
  font-size: 1.2rem;
  padding: 10px 20px;
  background: #2196F3;
  border: 2px solid #fff;
  margin-top: 10px;
}
</style>
</head>
<body>

<div class="app">
  <h3>Mac äººè‡‰è§£é–</h3>
  <div class="status" id="status">â³ æ¨¡å‹è¼‰å…¥ä¸­...</div>

  <div class="controls">
    <input type="text" id="nameInput" placeholder="è¼¸å…¥åå­— (ä¾‹: User)">
    <button onclick="startRegisterProcess()" id="btnRegister" disabled>ğŸ“¸ é–‹å§‹è¨»å†Š</button>
    <!-- è¾¨è­˜åŠŸèƒ½å·²ç§»è‡³ Mac èƒŒæ™¯åŸ·è¡Œ -->
  </div>

  <div class="video-container">
    <video id="video" autoplay muted playsinline></video>
    <div id="overlay-layer" class="overlay-layer" style="display: none;">
        <div class="overlay-content">
            <h2 id="overlay-msg">âœ… æ“·å–æˆåŠŸï¼</h2>
            <button id="btnNext" onclick="nextStep()">â¡ï¸ ç¹¼çºŒä¸‹ä¸€å¼µ</button>
        </div>
    </div>
  </div>
</div>

<script>
const video = document.getElementById('video');
const statusDiv = document.getElementById('status');
const overlayLayer = document.getElementById('overlay-layer');
const overlayMsg = document.getElementById('overlay-msg');
const btnRegister = document.getElementById('btnRegister');

const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

const REGISTRATION_STEPS = [
  { label: "1/5 è«‹æ­£å°é¡é ­ ğŸ˜", desc: "æ­£è‡‰" },
  { label: "2/5 è«‹å¾®å¾®å‘å·¦è½‰ ğŸ‘ˆ", desc: "å·¦å´è‡‰" },
  { label: "3/5 è«‹å¾®å¾®å‘å³è½‰ ğŸ‘‰", desc: "å³å´è‡‰" },
  { label: "4/5 è«‹å¾®å¾®æŠ¬é ­ ğŸ‘†", desc: "æŠ¬é ­" },
  { label: "5/5 è«‹å¾®å¾®ä½é ­ ğŸ‘‡", desc: "ä½é ­" }
];

let currentStepIndex = 0;
let collectedImages = []; // æ”¹ç‚ºå„²å­˜åœ–ç‰‡ Base64
let isRegistering = false;
let isPaused = false;
let lastUnlockTime = 0; // é˜²æ­¢é‡è¤‡è§¸ç™¼è§£é–

// 1. åˆå§‹åŒ–
Promise.all([
  faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
  faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
  faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
]).then(startVideo).catch(err => statusDiv.innerText = "âŒ æ¨¡å‹è¼‰å…¥å¤±æ•— (è«‹æª¢æŸ¥ç¶²è·¯)");

// 2. é–‹å•Ÿç›¸æ©Ÿ
async function startVideo() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
    });
    video.srcObject = stream;
    video.addEventListener('play', () => {
       statusDiv.innerText = "âœ… ç³»çµ±å°±ç·’";
       btnRegister.disabled = false;
    });
  } catch (err) {
    statusDiv.innerText = "âŒ ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ";
  }
}

// 3. é–‹å§‹è¨»å†Šæµç¨‹
function startRegisterProcess() {
  const name = document.getElementById('nameInput').value;
  if (!name) return alert("è«‹è¼¸å…¥åå­—");

  currentStepIndex = 0;
  collectedImages = [];
  isRegistering = true;
  isPaused = false;
  
  btnRegister.disabled = true;
  overlayLayer.style.display = 'none';
  statusDiv.innerText = `ğŸ“¸ æº–å‚™é–‹å§‹ï¼š${REGISTRATION_STEPS[0].label}`;
  
  registrationLoop(name);
}

function registrationLoop(name) {
  const timer = setInterval(async () => {
    if (!isRegistering || isPaused) return;

    if (currentStepIndex >= REGISTRATION_STEPS.length) {
      finishRegistration(name, timer);
      return;
    }

    const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();

    if (detection) {
      // æ“·å–ç•¶å‰ç•«é¢ç‚ºåœ–ç‰‡
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      collectedImages.push(canvas.toDataURL('image/jpeg'));

      isPaused = true; 
      showContinueOverlay();
    } else {
      statusDiv.innerText = `âš ï¸ åµæ¸¬ä¸­... ${REGISTRATION_STEPS[currentStepIndex].label}`;
    }
  }, 500);
}

function showContinueOverlay() {
  const stepInfo = REGISTRATION_STEPS[currentStepIndex];
  overlayMsg.innerText = `âœ… [${stepInfo.desc}] æ“·å–æˆåŠŸï¼`;
  overlayLayer.style.display = 'flex';
  statusDiv.innerText = "â¸ï¸ ç­‰å¾…ç¹¼çºŒ...";
}

function nextStep() {
  overlayLayer.style.display = 'none';
  currentStepIndex++;
  if (currentStepIndex < REGISTRATION_STEPS.length) {
    isPaused = false;
    statusDiv.innerText = `ğŸ“¸ ä¸‹ä¸€å¼µï¼š${REGISTRATION_STEPS[currentStepIndex].label}`;
    statusDiv.style.color = "#FFD700";
  } else {
    isPaused = false; 
  }
}

function finishRegistration(name, timer) {
  clearInterval(timer);
  isRegistering = false;
  
  statusDiv.innerText = "ğŸ“¤ æ­£åœ¨å‚³é€è³‡æ–™åˆ° Mac...";
  
  // å‚³é€åœ–ç‰‡åˆ° Python å¾Œç«¯
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  fetch('/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
          token: token,
          name: name,
          images: collectedImages 
      })
  })
  .then(response => {
      if (response.ok) {
          statusDiv.innerText = `ğŸ‰ ${name} è¨»å†ŠæˆåŠŸï¼Mac é–å®šæ™‚å°‡è‡ªå‹•è¾¨è­˜ã€‚`;
          statusDiv.style.color = "#4CAF50";
          alert("è¨»å†ŠæˆåŠŸï¼ç¾åœ¨æ‚¨å¯ä»¥é–å®š Mac é€²è¡Œæ¸¬è©¦ã€‚");
      } else {
          statusDiv.innerText = "âŒ è¨»å†Šå¤±æ•—";
      }
      btnRegister.disabled = false;
  })
  .catch(err => {
      console.error(err);
      statusDiv.innerText = "âŒ é€£ç·šéŒ¯èª¤";
  });
}
</script>
</body>
</html>